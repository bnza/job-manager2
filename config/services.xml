<?xml version="1.0" encoding="UTF-8" ?>

<container xmlns="http://symfony.com/schema/dic/services"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd">

    <parameters>
        <parameter key="bnza_job_manager.em_id">doctrine.orm.%bnza_job_manager.em_name%_entity_manager</parameter>
    </parameters>
    <services>

        <service id="bnza_job_manager.job_runner" class="Bnza\JobManagerBundle\Command\MigrateCommand" public="false">
            <argument type="service" id="%bnza_job_manager.em_id%"/>
        </service>

        <service id="bnza_job_manager.command.migrations_migrate" class="Bnza\JobManagerBundle\Command\MigrateCommand" public="false">
            <argument type="service" id="doctrine"/>
            <argument key="$emName" type="string">%bnza_job_manager.em_name%</argument>
            <tag name="console.command" command="bnza:job-manager:migrations:migrate"/>
        </service>

        <service id="bnza_job_manager.command.migrations_diff" class="Bnza\JobManagerBundle\Command\DiffCommand" public="false">
            <argument type="service" id="doctrine"/>
            <argument key="$emName" type="string">%bnza_job_manager.em_name%</argument>
            <tag name="console.command" command="bnza:job-manager:migrations:diff"/>
        </service>

        <service id="bnza_job_manager.job_repository" class="Bnza\JobManagerBundle\Repository\JobRepository" public="false">
            <argument type="service" id="%bnza_job_manager.em_id%"/>
            <tag name="doctrine.repository"/>
        </service>

        <service id="bnza_job_manager.job_locator" class="Bnza\JobManagerBundle\JobServicesIdLocator"/>

        <service id="bnza_job_manager.job_runner" class="Bnza\JobManagerBundle\JobRunner">
            <argument key="$registry" type="service" id="doctrine"/>
            <argument key="$emName" type="string">%bnza_job_manager.em_name%</argument>
            <argument key="$locator" type="service" id="bnza_job_manager.job_locator"/>
        </service>

        <service id="bnza_job_manager.job_event_subscriber" class="Bnza\JobManagerBundle\EventSubscriber\JobSubscriber" public="false">
            <argument key="$registry" type="service" id="doctrine"/>
            <argument key="$emName" type="string">%bnza_job_manager.em_name%</argument>
            <argument key="$cacheHelper" type="service" id="bnza_job_manager.cache_helper"/>
            <tag name="kernel.event_subscriber" lazy="true"/>
        </service>

        <service id="bnza_job_manager.abstract_work_unit" class="Bnza\JobManagerBundle\AbstractWorkUnit" abstract="true" shared="false">
            <argument key="$eventDispatcher" type="service" id="event_dispatcher"/>
        </service>

        <service id="bnza_job_manager.abstract_job" class="Bnza\JobManagerBundle\AbstractJob" parent="bnza_job_manager.abstract_work_unit"
            abstract="true" shared="false">
            <tag name="bnza_job_manager.job"/>
        </service>

        <service id="bnza_job_manager.abstract_task" class="Bnza\JobManagerBundle\AbstractTask" parent="bnza_job_manager.abstract_work_unit"
            abstract="true" shared="false">
            <tag name="bnza_job_manager.task"/>
        </service>

        <service id="bnza_job_manager.cache_helper" class="Bnza\JobManagerBundle\CacheHelper" lazy="true">
            <argument key="$cache" type="service" id="%cache_pool_name%"/>
        </service>
        <service id="Bnza\JobManagerBundle\State\WorkUnitItemProvider" class="Bnza\JobManagerBundle\State\WorkUnitItemProvider" lazy="true">
            <argument key="$entityManager" type="service" id="%bnza_job_manager.em_id%"/>
            <argument key="$cache" type="service" id="bnza_job_manager.cache_helper"/>
            <argument key="$denormalizer" type="service" id="serializer"/>
            <tag name="api_platform.state_provider"/>
        </service>
        <service id="bnza_job_manager.work_unit_item_provider" alias="Bnza\JobManagerBundle\State\WorkUnitItemProvider"/>
        <service id="bnza_job_manager.job_runner_message_handler" class="Bnza\JobManagerBundle\MessageHandler\JobRunnerMessageHandler">
            <argument type="service" id="bnza_job_manager.job_runner"/>
            <tag name="messenger.message_handler"/>
        </service>
    </services>

</container>
